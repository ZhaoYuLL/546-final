<!DOCTYPE html>
<html>
  <head>
    <title>My User Profile</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <div class="profile picture">
      <div class="profile-pic"></div>
    </div>
    <div>
      <p id="welcome">Welcome {{firstName}} {{lastName}}</p>
      <h2 id="userName">{{userName}}</h2>
    </div>
    <div></div>
    <div class="container">
      <section class="profile"></section>
      <div class="bio"></div>
    </div>

    <div class="fitposts-container">
      <h1>My fitposts</h1>
      {{#each allFitposts}}
      <div class="fitpost" data-fitpost-id="{{@index}}">
        <h1>Fitpost {{addOne @index}}</h1>
        <p>Headwear:</p>
        <img
          src="{{this.headUrl}}"
          width="200px;"
          height="200px"
          alt="Head Image"
        />
        <p>Bodywear:</p>
        <img
          src="{{this.bodyUrl}}"
          width="200px;"
          height="200px"
          alt="Body Image"
        />
        <p>Legwear:</p>
        <img
          src="{{this.legUrl}}"
          width="200px;"
          height="200px"
          alt="Leg Image"
        />
        <p>Footwear:</p>
        <img
          src="{{this.footUrl}}"
          width="200px;"
          height="200px"
          alt="Foot Image"
        />

        <button class="edit-fitpost" data-fitpost-id="{{@index}}">Edit</button>
        <button class="delete-fitpost" data-fitpost-id="{{@index}}">
          Delete
        </button>
      </div>
      {{/each}}
    </div>

    <!-- Edit Fitpost Modal -->
    <div id="editFitpostModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Fitpost</h2>
        <form id="editFitpostForm">
          <input type="hidden" id="editFitpostId" name="fitpostId" />
          <label for="editHeadwearSelect">Headwear:</label>
          <select id="editHeadwearSelect" name="headwearSelect"></select>
          <label for="editBodywearSelect">Bodywear:</label>
          <select id="editBodywearSelect" name="bodywearSelect"></select>
          <label for="editLegwearSelect">Legwear:</label>
          <select id="editLegwearSelect" name="legwearSelect"></select>
          <label for="editFootwearSelect">Footwear:</label>
          <select id="editFootwearSelect" name="footwearSelect"></select>
          <button type="submit">Update Fitpost</button>
        </form>
      </div>
    </div>

    <a id="logoutLink" href="/logout">Logout</a>

    <script>
      $(document).ready(function () {
        // Add event listener to the "Edit" button
        $(".edit-fitpost").on("click", function () {
          var fitpostId = $(this).data("fitpost-id");
          openEditModal(fitpostId);
        });

        // Function to handle the update fitpost form submission
        $("#editFitpostForm").on("submit", function (event) {
          event.preventDefault();

          var fitpostId = $("#editFitpostId").val();
          var headwearSelect = $("#editHeadwearSelect").val();
          var bodywearSelect = $("#editBodywearSelect").val();
          var legwearSelect = $("#editLegwearSelect").val();
          var footwearSelect = $("#editFootwearSelect").val();

          var formData = {
            fitpostId: fitpostId,
            headwearSelect: headwearSelect,
            bodywearSelect: bodywearSelect,
            legwearSelect: legwearSelect,
            footwearSelect: footwearSelect,
          };

          $.ajax({
            url: "/userprofile/update-fitpost",
            method: "POST",
            data: formData,
            success: function (response) {
              console.log("Fitpost updated successfully:", response);
              // Optionally, you can close the modal and update the UI
              closeModal();
              updateFitpostUI(fitpostId, response);
            },
            error: function (xhr, status, error) {
              console.error("Error updating fitpost:", error);
              // Optionally, display an error message to the user
            },
          });
        });
      });

      function openEditModal(fitpostId) {
        var headwearSelect = $("#editHeadwearSelect");
        var bodywearSelect = $("#editBodywearSelect");
        var legwearSelect = $("#editLegwearSelect");
        var footwearSelect = $("#editFootwearSelect");

        // Clear existing options
        headwearSelect.empty();
        bodywearSelect.empty();
        legwearSelect.empty();
        footwearSelect.empty();

        // Find the corresponding fitpost
        var fitpost = $('.fitpost[data-fitpost-id="' + fitpostId + '"]');

        // Get the image URLs for the selected fitpost
        var headUrl = fitpost.find('img[alt="Head Image"]').attr("src");
        var bodyUrl = fitpost.find('img[alt="Body Image"]').attr("src");
        var legUrl = fitpost.find('img[alt="Leg Image"]').attr("src");
        var footUrl = fitpost.find('img[alt="Foot Image"]').attr("src");

        // Populate dropdown menus with images from all fitposts
        $(".fitpost").each(function (index) {
          var fitpostIndex = $(this).data("fitpost-id");
          var headImg = $(this).find('img[alt="Head Image"]');
          var bodyImg = $(this).find('img[alt="Body Image"]');
          var legImg = $(this).find('img[alt="Leg Image"]');
          var footImg = $(this).find('img[alt="Foot Image"]');

          headwearSelect.append(
            '<option value="' +
              fitpostIndex +
              '" data-image="' +
              headImg.attr("src") +
              '">Fitpost ' +
              (fitpostIndex + 1) +
              "</option>"
          );
          bodywearSelect.append(
            '<option value="' +
              fitpostIndex +
              '" data-image="' +
              bodyImg.attr("src") +
              '">Fitpost ' +
              (fitpostIndex + 1) +
              "</option>"
          );
          legwearSelect.append(
            '<option value="' +
              fitpostIndex +
              '" data-image="' +
              legImg.attr("src") +
              '">Fitpost ' +
              (fitpostIndex + 1) +
              "</option>"
          );
          footwearSelect.append(
            '<option value="' +
              fitpostIndex +
              '" data-image="' +
              footImg.attr("src") +
              '">Fitpost ' +
              (fitpostIndex + 1) +
              "</option>"
          );
        });

        headwearSelect.val(fitpostId);
        bodywearSelect.val(fitpostId);
        legwearSelect.val(fitpostId);
        footwearSelect.val(fitpostId);

        // Customize the appearance of the dropdown options
        $("select").each(function () {
          $(this).css({
            width: "200px",
            height: "200px",
            "background-size": "cover",
            "background-repeat": "no-repeat",
            "background-position": "center",
            padding: "10px",
          });

          $(this).on("change", function () {
            var selectedOption = $(this).find("option:selected");
            var imageUrl = selectedOption.data("image");
            $(this).css("background-image", 'url("' + imageUrl + '")');
          });

          // Set the initial background image based on the selected option
          var selectedOption = $(this).find("option:selected");
          var imageUrl = selectedOption.data("image");
          $(this).css("background-image", 'url("' + imageUrl + '")');
        });

        // Show the edit modal
        $("#editFitpostModal").css("display", "block");

        // Set the fitpost ID in the hidden input field
        $("#editFitpostId").val(fitpostId);
      }

      // Function to close the modal
      function closeModal() {
        $("#editFitpostModal").css("display", "none");

        // Clear the select elements
        $("select").empty().css("background-image", "");
      }

      // Function to update the fitpost UI after successful update
      function updateFitpostUI(fitpostId, updatedFitpost) {
        var fitpostElement = $('.fitpost[data-fitpost-id="' + fitpostId + '"]');
        // Update the fitpost element with the updated data
        // ...
      }

      // Function to display the image dynamically
      function displayImage(imageUrl) {
        var imgElement = $("<img>").attr({
          src: imageUrl,
          alt: "Dynamic Image",
          width: 200,
          height: 200,
        });

        $(".container").append(imgElement);
      }

      // Example usage of displayImage function
      var imageUrl =
        "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRS1u05OPc7MSt9f5Dg2QMSbRPu_FHowIjog-jxeSwHIw&s";
      displayImage(imageUrl);
    </script>
  </body>
</html>
